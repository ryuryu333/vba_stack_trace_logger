# VBA Stack Trace Logger

作業中です...  

## ロガーの機能へアクセスする
`MyLogger.` と打ち込む事で、ロガーの全ての機能にアクセス可能です。  

`.` を記入すると VBE にてインテリセンスが表示されるので、使用したい機能を選択してください。  

### Note インテリセンスを頼ろう
VBE にて `Ctrl` + `Space` を押すと、インテリセンスを表示できます。  
本ロガーではインテリンス機能に対応したコードを作成しており、`MyLogger` 以外のワードは暗記しなくても良いようにしています。  

## ロガーの挙動をカスタマイズする
ロガーの設定を行います。  
初期化処理を兼ねているので、ロガーを利用する前に必ず実行してください。  

```vba
' デフォルトの設定を利用する場合
MyLogger.StartConfiguration.Build

' カスタマイズする場合
MyLogger.StartConfiguration.SomeSetting.Build
```

デフォルトの設定は最低限の構成にしています。
- スタックトレース機能は無効化
- ログ出力先は VBE イミディエイトウインドウのみ

以下のプロシージャをメソッドチェーンとして使用することで、各設定を反映させることができます。

| プロシージャ名                    | 説明                                                                 |
|---------------------------|----------------------------------------------------------------------|
| `DisableLogging`          | ログ出力を無効化します。                                            |
| `EnableTagFiltering`      | 指定されたタグのログ出力を無効化します。                           |
| `EnableStackTrace`        | スタックトレース機能を有効化します。                               |
| `DisableWriteToImmediate` | VBE のイミディエイトウィンドウへのログ出力を無効化します。         |
| `EnableWriteToExcelSheet` | 指定されたエクセルシートへのログ出力を有効化します。               |

**EnableTagFiltering** を使用した場合、次のメソッドチェーンは `Add` と `Apply` に限定されます。  
`Add(LogTag_Debug)` のようにログ出力を無効化したいタグを指定します。  
複数のタグを指定したい場合は、`Add` を繰り返します。  
指定が完了したら `Apply` を使用してください。  

**EnableWriteToExcelSheet** を使用した場合、次のメソッドチェーンは `SetOutputExcelSheet` に限定されます。  
`SetOutputExcelSheet(ActiveSheet)` のように `Worksheet` 型の値を引数に渡してください。  
指定されたシートにログ出力が行われます。  
ロガー初期化処理でシートの内容は全てクリアされるので、ログ専用のシートを準備してください。  

全ての設定を指定し終えたら、`Build` を使用します。

### ログを出力する

```vba
' 通常
MyLogger.Log "Your Message"

' タグを指定する場合（未指定だと INFO）
MyLogger.Log "Your Message", LogTag_Debug
```

## スタックトレース機能を使用する
以下の2ステップが必要となります。  

1. モジュール名を表す変数をモジュール冒頭に記述する
2. プロシージャの開始・終了を検知するためのコードをコピペし、プロシージャ名を記述する

#### 1. モジュール名を表す変数をモジュール冒頭に記述する
モジュールの冒頭、`Option Explicit` を宣言した次の行（=2行目）などに以下をコピペします。  
"YourModuleName" の部分には編集中のモジュール名を記載してださい。  

```vb
Private Const MODULE_NAME As String = "YourModuleName"
```

#### 2. プロシージャの開始・終了を検知するためのコードをコピペする
スタックトレースの対象に含めたいプロシージャの冒頭に以下をコピペします。  
"YourProcedureName" の部分にはプロシージャ名を記載してださい。  

```vb
Const PROC_NAME As String = "YourProcedureName": Dim scopeGuard As Variant: Set scopeGuard = myLogger.UsingTracer(MODULE_NAME, PROC_NAME)
```

>※ 網羅的なスタックトレース情報を得るために、全てのプロシージャに上記コードを記入することをお勧めします。  
>ただし、ループ処理で大量に呼び出す場合、処理が単独で完結しトレースする必要性が無い場合、などは対象外にすると良いと思います。

>※ 本機能は変数のライフサイクルを利用して、コールスタック情報を更新しています。
>上記コードでは、変数 `scopeGuard` に本ロガー独自のクラスのインスタンスを代入しています。  
>インスタンス生成時にプロシージャ開始を検知しています。
>変数 `scopeGuard` が所属するプロシージャが終了した場合、この変数の参照数は 0 となり、システム的に自動破棄されます。
>変数内のインスタンスが破棄されるタイミングでプロシージャ終了を検知しています。


## ロガーの終了処理を行う

```
myLogger.Terminate
```
